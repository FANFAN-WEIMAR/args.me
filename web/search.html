<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="css/search.css"/>
<title>Results</title>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.5/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/numericjs@1.2.6/numeric-1.2.6.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/mathjs/3.18.1/math.min.js"></script>

<script src="js/mds.js"></script>
<script src="js/barycentric.js"></script>
<script src="js/lodash.js"></script>

<script type="text/javascript">

  function startSearch() {
    if (searchText.value === "") {
      console.log('value not set ');
      search(searchText.placeholder)
      .then(sendJSON)
      .then(tabOpenBarycentric);
    }
    else {
      // console.log('value set ', searchText.value);
      // searchText.placeholder = searchText.value;
      // window.location.search.replace(/^\?q=/, searchText.value);
      search(searchText.value)
      .then(sendJSON)
      .then(tabOpenBarycentric);
    }
  }

	window.onload=function(){
		let queryString = window.location.search.replace(/^\?q=/,'');
    queryString = queryString.split("&",1);
    searchText.value = queryString;
		searchText.placeholder = 'Search...';

    // TODO: write working functoin for onclick event!!!
    var searchButton = document.querySelector('.searchButton');
    searchButton.addEventListener('onclick', startSearch());

		//tabOpenProCon();
    //polygonCheck();
	}
</script>

<script type="text/javascript">

	var labels = [
			'Economy',
			'Society',
			'Education',
			'Culture',
			'Environment',
			'Human Right'];

</script>

<script type="text/javascript">

	function euclidean(cityData){

		var cityPositions = numeric.transpose(mds.classic(cityData));
		// console.log(mds.classic(cityData));
		// console.log(cityPositions);
		var w = Math.min(600, document.documentElement.clientWidth - 20),
				h = w /2;
		mds.drawD3ScatterPlot(d3.select("#euclideanDistance"),
				cityPositions[0],
				cityPositions[1],
				labels,
				{
						w :  Math.min(600, document.documentElement.clientWidth - 20),
						h : w /2,
						padding : 37,
						reverseX : true,
						reverseY : true,
				});
	}
	function KL(cityData){
		var cityPositions = numeric.transpose(mds.KL(cityData));
		//console.log(cityPositions);
		var w = Math.min(600, document.documentElement.clientWidth - 20),
				h = w /2;
		mds.drawD3ScatterPlot(d3.select("#KLDistance"),
				cityPositions[0],
				cityPositions[1],
				labels,
				{
						w :  Math.min(600, document.documentElement.clientWidth -20),
						h : w /2,
						padding : 37,
						reverseX : true,
						reverseY : true,
				});
	}
	function Cosin(cityData){
		var cityPositions = numeric.transpose(mds.Cosin(cityData));
		//console.log(cityPositions);
		var w = Math.min(600, document.documentElement.clientWidth - 20),
				h = w /2;
		mds.drawD3ScatterPlot(d3.select("#CosineSimilarity"),
				cityPositions[0],
				cityPositions[1],
				labels,
				{
						w :  Math.min(600, document.documentElement.clientWidth -20),
						h : w /2,
						padding : 37,
						reverseX : true,
						reverseY : true,
				});
	}


</script>

<script type="text/javascript">

	function searchQuery(){
		var query=document.getElementById('searchText').value;
		if(query==""){
			var query=window.location.search.replace(/^\?q=/,'');
			var query=query.split("&",1);
		}
		search(query);
	}

  function sendJSON(data) {
    // console.log('number of argument send: ',  data);
    var url = 'http://localhost:3000/';
    return fetch(url, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: new Headers({
          'Content-Type': 'application/json'
        })
      })
      .then(res => res.json())
      .catch(error => console.error('Error: ', error))
      .then((res) => {
        console.log('revieved from server: ', res);
        return res;
      });
  };

	function search(query){
		var apiURL="http://141.54.172.105:8081/api/v1/_search?query=" + query;
    return fetch(apiURL)
      .then(res => res.json())
      .then(function (data) {
        let argumentList = [];
        // console.log(data);
        let args = data.results;
        let regex =  /(debatepedia|debatewise|forandagainst|idebate|debate)\./g;
        for(let arg of args) {
          let portal = arg.url.match(regex)[0];
          portal = portal.slice(0, -1);

          let argID = portal
                      + '-' + arg.discussionID
                      + '-' + arg.argumentID;
          argumentList.push(argID);
        }
        console.log('ArgumentList: ',argumentList);
        return argumentList;

        //FANFAN
        // var length = data.results.length;
        // var conclusion, stance;
  			// var div=document.getElementById('ProVsCon');
  			// var divPro=document.getElementById('Pro');
  			// var divCon=document.getElementById('Con');
        // while(divPro.firstChild){
  			// 	divPro.removeChild(divPro.firstChild);
  			// }
  			// while(divCon.firstChild){
  			// 	divCon.removeChild(divCon.firstChild);
  			// }
        //
  			// for(var i=0;i<length;i++){
  			// 	conclusion=data.results[i].conclusion;
  			// 	stance=data.results[i].stance;
  			// 	if(stance==true){
  			// 		var iDiv = document.createElement('div');
  			// 		iDiv.innerHTML=conclusion;
  			// 		div.appendChild(iDiv);
  			// 		document.getElementById('Pro').appendChild(iDiv);
  			// 	}else{
  			// 		var iDiv = document.createElement('div');
  			// 		iDiv.innerHTML=conclusion;
  			// 		div.appendChild(iDiv);
  			// 		document.getElementById('Con').appendChild(iDiv);
  			// 	}
  			// }
      });
	}

  function polygonCheck(content){

    function num_uniq_topics(content) {
      var set = new Set();
      let noTopicCount = 0;
      for(let arg of content) {
        if(arg.hasOwnProperty('topics')) {
          for(let topic_tuple of arg.topics) {
            set.add(topic_tuple.topic);
          }
        }
        else {
          noTopicCount += 1;
          continue;
        }
      }
      console.log('number of uniq topics: ', set.size);
      console.log('number of arg without topics: ', noTopicCount);
      return set;
    };
    var topicNum = num_uniq_topics(content);

		d3.text("topic_dist_per_doc.txt",function(data){

			cleanSvg();

			var argumentData=getArgumentData(data);
			// console.log(argumentData);
			var topicsNum=getTopicsNum(argumentData);
			// console.log(topicsNum);
			var preparedLabels=setLabel(topicsNum);
			// console.log(preparedLabels);
			var checkedTopics=topicsSelection();
			var verticesNumber=checkedTopics.length;
			//console.log(verticesNumber);
			var processedData=argumentAfterTopicSelection(checkedTopics,argumentData,topicsNum);
			//console.log(processedData);
			var processedLabel=topicsAfterTopicSelection(checkedTopics,preparedLabels);
			// console.log(processedLabel);



			function getArgumentData(data){
				var argumentData=[];
				var data=data.split(/[[\]]/);
				for(var i=0;i<data.length;i++){
					if(isNaN(data[i])){
						data[i]=data[i].replace(/,/g,"");
						data[i]=data[i].split(/[(\)]/).filter(clean);
						argumentData.push(data[i]);
					}
				}
				//console.log(argumentData);
				for(var i=0;i<argumentData.length;i++){
					for(var j=0;j<argumentData[i].length;j++){
						var cell=argumentData[i][j].split(" ");
						var topicID=cell[0];
						var freq=cell[1];

						var newCell = {};
						newCell.topicID = topicID;
						newCell.freq = freq;
						argumentData[i][j]=newCell;
					}
				}
				return argumentData;
			}
			function getTopicsNum(argumentData){
				var arrayTopic=[]
				for(var i=0;i<argumentData.length;i++){
					for(var j=0;j<argumentData[i].length;j++){
						arrayTopic.push(argumentData[i][j].topicID);
					}
				}
				return Math.max.apply(null, arrayTopic);
			}
			function setLabel(num){
				var labelsA=[];
				for(i=0;i<num;i++){
					//labelsA[i]="topic"+(i);
					labelsA[i]=labels[i];
				}
				return labelsA;
			}
			function topicsSelection(){
				var checkedTopics=[];
				var topics=document.getElementsByName('topic');
				for(var i=0;i<topics.length;i++){
					if(topics[i].checked){
						checkedTopics.push(i);
					}
				}
				return checkedTopics;
			}
			function argumentAfterTopicSelection(checkedTopics,argumentData,topicsNum){
				var freqArray=[];
				for(var i=0;i<argumentData.length;i++){
					freqArray[i]=new Array(topicsNum);
				}

				for(var i=0;i<argumentData.length;i++){
					for(var k=0;k<argumentData[i].length;k++){
						for(var j=0;j<topicsNum;j++){
							if(j==argumentData[i][k].topicID){
								freqArray[i][j]=argumentData[i][k].freq;
							}else if(freqArray[i][j]>0){
								freqArray[i][j]=freqArray[i][j];
							}else{
								freqArray[i][j]=0;
							}
						}
					}
				}
				//console.log(freqArray);

				var col=freqArray[0].length;
				var row=freqArray.length;

				var processedData=[];
				for(var i=0;i<row;i++){
					processedData[i]=new Array(checkedTopics.length);
				}

				//console.log(processedData);
				for (var a=0;a<row;a++){
					for (var b=0;b<checkedTopics.length;b++){
						var n=checkedTopics[b];
						var m=parseFloat(freqArray[a][n])
						processedData[a][b]=m;
					}
				}
				//console.log(processedData);


				return processedData;
			}
			function topicsAfterTopicSelection(checkedTopics, labels){
				var processedLabel=[];
				for(var a=0;a<checkedTopics.length;a++){
					processedLabel[a]=labels[checkedTopics[a]]
				}
				return processedLabel;
			}
			function clean(value){
				if(isNaN(value)){
					return true;
				}
			}
			function cleanSvg(){
				var Polygon=document.getElementById('polygon');
				while(Polygon.firstChild){
					Polygon.removeChild(Polygon.firstChild);
				}
			}
			// console.log(processedDataWithoutNull);
			polygon(processedData,d3.select('#polygon'),200,verticesNumber,processedLabel);
		});
	}

</script>

<script type="text/javascript">

	function clear(){
		var item=document.getElementById('resultDisplay');
		while(item.firstChild){
			item.removeChild(item.firstChild);
		}
	}

  function tabOpenProCon(){
		prepare();
		searchQuery()
		function prepare(){
			clear();
	    var ProVsCon=document.createElement("div");
	    document.getElementById("resultDisplay").appendChild(ProVsCon);
			ProVsCon.setAttribute("id","ProVsCon");

			var Pro=document.createElement("div");
			document.getElementById("ProVsCon").appendChild(Pro);
			Pro.setAttribute("id","Pro");

			var Con=document.createElement("div");
			document.getElementById("ProVsCon").appendChild(Con);
			Con.setAttribute("id","Con");
		}
	}

  function tabOpenMds(){
		prepare();
		d3.text("topic_dist_per_doc.txt",function(data){
			var argumentData=getArgumentData(data);
			var topicsNum=getTopicsNum(argumentData);
			var processedData=getProcessedData(argumentData,topicsNum);
			//console.log(processedData);


			function getArgumentData(data){
				var argumentData=[];
				var data=data.split(/[[\]]/);
				for(var i=0;i<data.length;i++){
					if(isNaN(data[i])){
						data[i]=data[i].replace(/,/g,"");
						data[i]=data[i].split(/[(\)]/).filter(clean);
						argumentData.push(data[i]);
					}
				}
				//console.log(argumentData);
				for(var i=0;i<argumentData.length;i++){
					for(var j=0;j<argumentData[i].length;j++){
						var cell=argumentData[i][j].split(" ");
						var topicID=cell[0];
						var freq=cell[1];

						var newCell = {};
						newCell.topicID = topicID;
						newCell.freq = freq;
						argumentData[i][j]=newCell;
					}
				}
				return argumentData;
			}
			function getTopicsNum(argumentData){
				var arrayTopic=[]
				for(var i=0;i<argumentData.length;i++){
					for(var j=0;j<argumentData[i].length;j++){
						arrayTopic.push(argumentData[i][j].topicID);
					}
				}
				return Math.max.apply(null, arrayTopic);
			}
			function getProcessedData(argumentData,topicsNum){
				var freqArray=[];
				for(var i=0;i<argumentData.length;i++){
					freqArray[i]=new Array(topicsNum);
				}

				for(var i=0;i<argumentData.length;i++){
					for(var k=0;k<argumentData[i].length;k++){
						for(var j=0;j<topicsNum;j++){
							if(j==argumentData[i][k].topicID){
								freqArray[i][j]=argumentData[i][k].freq;
							}else if(freqArray[i][j]>0){
								freqArray[i][j]=freqArray[i][j];
							}else{
								freqArray[i][j]=0;
							}
						}
					}
				}
				//console.log(freqArray);
				return freqArray;
			}
			function clean(value){
				if(isNaN(value)){
					return true;
				}
			}
			euclidean(processedData);
			KL(processedData);
			Cosin(processedData);
		});
		function prepare(){
			clear();
			var mds=document.createElement("div");
			document.getElementById("resultDisplay").appendChild(mds);
			mds.setAttribute("id","mds");

			var euclideanDistance=document.createElement("div");
	    document.getElementById("mds").appendChild(euclideanDistance);
			euclideanDistance.setAttribute("id","euclideanDistance");

			var KLDistance=document.createElement("div");
	    document.getElementById("mds").appendChild(KLDistance);
			KLDistance.setAttribute("id","KLDistance");

			var CosineSimilarity=document.createElement("div");
	    document.getElementById("mds").appendChild(CosineSimilarity);
			CosineSimilarity.setAttribute("id","CosineSimilarity");
		}
 	}

  function tabOpenBarycentric(data){
    console.log('data availabe inside bary', data);
		prepare();
		polygonCheck(data);

		 for(var i=0;i<labels.length;i++){
		 	var subCheckbox=document.createElement("input");
			subCheckbox.type="checkbox";
			subCheckbox.class="checkbox"
			subCheckbox.name="topic";
			subCheckbox.value=labels[i];
			subCheckbox.id="id"+i;
			subCheckbox.class="box";
			subCheckbox.checked="checked";
			// subCheckbox.onclick=polygonCheck;
	   	document.getElementById("checkbox").appendChild(subCheckbox);

			var label=document.createElement("label");
			label.htmlFor=labels[i];
	 	  label.appendChild(document.createTextNode(labels[i]));
			document.getElementById("checkbox").appendChild(label);
	 	 	//checkbox.setAttribute("id","checkbox");
		 }
		 function prepare(){
 			clear();

 			var barycentric=document.createElement("div");
 			document.getElementById("resultDisplay").appendChild(barycentric);
 			barycentric.setAttribute("id","barycentric");

 			var polygon=document.createElement("div");
 			document.getElementById("barycentric").appendChild(polygon);
 			polygon.setAttribute("id","polygon");

 			var checkbox=document.createElement("div");
 			document.getElementById("barycentric").appendChild(checkbox);
 			checkbox.setAttribute("id","checkbox");
 			}
	}
</script>

</head>

<body>
	<div id="container">
		<div id="header">
			<h1>Args.me</h1>
			<div class="SearchContainer">
					<input id="searchText" type="text" class="searchTerm"/>
					<button type="submit" class="searchButton" >Go!</button>
			</div>
		</div>
		<div id="body">
      <div id="tab">
        <ul>
          <li class="tablinks" onclick="tabOpenProCon()">Pro Vs. Con</li>
          <li class="tablinks" > | </li>
          <li class="tablinks" onclick="tabOpenMds()">MDS</li>
          <li class="tablinks" > | </li>
          <li class="tablinks" onclick="tabOpenBarycentric()">Barycentric </li>
        </ul>
      </div>
			<div id="resultDisplay"></div>
		</div>
		<div id="footer">
			<ul>
        	<li class="float-left"><a href="">HELP</a></li>
          <li class="float-left"><a href="">TERMS</a></li>
          <li class="float-left"><a href="">PRIVACY</a></li>
          <li class="float-left"><a href="">API</a></li>
          <li class="float-right"><a href="">ABOUT</a></li>
          <li class="float-right"><a href="">@2017WEBIS</a></li>
        </ul>
		</div>
	</div>
</body>
</html>
