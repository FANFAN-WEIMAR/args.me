<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="css/search.css"/>
<title>Results</title>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.5/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/numericjs@1.2.6/numeric-1.2.6.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/mathjs/3.18.1/math.min.js"></script>

<script src="js/mds.js"></script>
<script src="js/barycentric.js"></script>

<script type="text/javascript">

  function startSearch() {
    if (searchText.value === "") {
      console.log('value not set ');
      search(searchText.placeholder)
      .then(sendJSON)
      .then(tabOpenBarycentric);
    }
    else {
      // console.log('value set ', searchText.value);
      // searchText.placeholder = searchText.value;
      // window.location.search.replace(/^\?q=/, searchText.value);
      search(searchText.value)
      .then(sendJSON)
      .then(tabOpenBarycentric);
    }
  }

  window.onload=function(){
		let queryString = window.location.search.replace(/^\?q=/,'');
    queryString = queryString.split("&",1);
    searchText.value = queryString;
		searchText.placeholder = 'Search...';
    // TODO: write working functoin for onclick event!!!
    var searchButton = document.querySelector('.searchButton');
    searchButton.addEventListener('onclick', startSearch());
		//tabOpenProCon();
    //polygonCheck();
	}

</script>

<script type="text/javascript">

	var labels = [
			'Economy',
			'Society',
			'Education',
			'Culture',
			'Environment',
			'Human Right'];

</script>

<script type="text/javascript">

	function euclidean(cityData){

		var cityPositions = numeric.transpose(mds.classic(cityData));
		// console.log(mds.classic(cityData));
		// console.log(cityPositions);
		var w = Math.min(600, document.documentElement.clientWidth - 20),
				h = w /2;
		mds.drawD3ScatterPlot(d3.select("#euclideanDistance"),
				cityPositions[0],
				cityPositions[1],
				labels,
				{
						w :  Math.min(600, document.documentElement.clientWidth - 20),
						h : w /2,
						padding : 37,
						reverseX : true,
						reverseY : true,
				});
	}
	function KL(cityData){
		var cityPositions = numeric.transpose(mds.KL(cityData));
		//console.log(cityPositions);
		var w = Math.min(600, document.documentElement.clientWidth - 20),
				h = w /2;
		mds.drawD3ScatterPlot(d3.select("#KLDistance"),
				cityPositions[0],
				cityPositions[1],
				labels,
				{
						w :  Math.min(600, document.documentElement.clientWidth -20),
						h : w /2,
						padding : 37,
						reverseX : true,
						reverseY : true,
				});
	}
	function Cosin(cityData){
		var cityPositions = numeric.transpose(mds.Cosin(cityData));
		//console.log(cityPositions);
		var w = Math.min(600, document.documentElement.clientWidth - 20),
				h = w /2;
		mds.drawD3ScatterPlot(d3.select("#CosineSimilarity"),
				cityPositions[0],
				cityPositions[1],
				labels,
				{
						w :  Math.min(600, document.documentElement.clientWidth -20),
						h : w /2,
						padding : 37,
						reverseX : true,
						reverseY : true,
				});
	}


</script>

<script type="text/javascript">

	function searchQuery(){
		var searchValue=document.getElementById('searchText').value;
		if(searchValue==""){
			var searchValue=window.location.search.replace(/^\?q=/,'');
			var searchValue=searchValue.split("&",1);
		}
		search(searchValue);
	}

  function sendJSON(data) {
    // console.log('number of argument send: ',  data);
    let url = 'http://localhost:3000/';
    return fetch(url, {
        method: 'POST',
        body: JSON.stringify(data[0]),
        headers: new Headers({
          'Content-Type': 'application/json'
        })
      })
      .then(res => res.json())
      .catch(error => console.error('Error: ', error))
      .then((res) => {
        data[1].forEach(function (argument) {
          let argumentMatch = res.filter(function (arg) {
            return arg.id === argument.id
          });
          argument.topics = (argumentMatch[0] !== undefined ? argumentMatch[0].topics : null);
        })
        // console.log('recieved from server: ', data[1]);
        return data[1];
      });
  };

	function search(query){
		let apiURL="http://www.args.me/api/v1/_search?query=" + query;
    return fetch(apiURL)
      .then(res => res.json())
      .then(function (data) {
        let argumentList = [];
        // console.log(data);
        let args = data.results;
        let regex =  /(debatepedia|debatewise|forandagainst|idebate|debate)\./g;
        for(let arg in args) {
          let portal = args[arg].url.match(regex)[0];
          portal = portal.slice(0, -1);

          let argID = portal
                      + '-' + args[arg].discussionID
                      + '-' + args[arg].argumentID;
          argumentList.push(argID);
          args[arg].id = argID;
        }
        // console.log('ArgumentList: ', argumentList, args);
        return [argumentList, args];

        //FANFAN
        // var length = data.results.length;
        // var conclusion, stance;
  			// var div=document.getElementById('ProVsCon');
  			// var divPro=document.getElementById('Pro');
  			// var divCon=document.getElementById('Con');
        // while(divPro.firstChild){
  			// 	divPro.removeChild(divPro.firstChild);
  			// }
  			// while(divCon.firstChild){
  			// 	divCon.removeChild(divCon.firstChild);
  			// }
        //
  			// for(var i=0;i<length;i++){
  			// 	conclusion=data.results[i].conclusion;
  			// 	stance=data.results[i].stance;
  			// 	if(stance==true){
  			// 		var iDiv = document.createElement('div');
  			// 		iDiv.innerHTML=conclusion;
  			// 		div.appendChild(iDiv);
  			// 		document.getElementById('Pro').appendChild(iDiv);
  			// 	}else{
  			// 		var iDiv = document.createElement('div');
  			// 		iDiv.innerHTML=conclusion;
  			// 		div.appendChild(iDiv);
  			// 		document.getElementById('Con').appendChild(iDiv);
  			// 	}
  			// }
      });
	}

  function polygonCheck(content){
    /* NOTE: things to calculate for polygon()
        - topicsNum:      number of uniq topics
        - processedLabel: label names for topics
        - verticesNumber: currently active topics

        - function to filter data by six highest topics
        - argumentData returns condensed version of filtered dataset
        - write processedData(createMatrix) to get matrix of arg -> topics mapping
    */

    let clonedContent = _.clone(content, true);
    // all properties of the content but only with arguments that have topics
    let argumentData = clonedContent.filter(arg => arg.topics !== undefined);

    // return array of topics sorted by descending occurence
    function getTopicArray(array) {
      let topicMap = d3.map();

      // count occurence of topics
      array.forEach(function (arg, i) {
        for (topicTuple of arg.topics) {
          if(topicMap.has(topicTuple.topic)) {
            topicMap.set(String(topicTuple.topic), topicMap.get(topicTuple.topic) + 1);
          }
          else {
            topicMap.set(topicTuple.topic, 1);
          }
        }
      });

      // sort topics descending
      let topicArray = topicMap.entries().sort(function (a, b) {
        if(a.value < b.value) {return 1;}
        if(a.value > b.value) {return -1;}
        return 0;
      });
      return topicArray;
    }

    // sorted topicArray by occurence
    let topicArray = getTopicArray(argumentData).map((a) => a.key);
    console.log('topicArray', topicArray);

    // add all topics to args in argumentData
    let topicsVectorExpand = argumentData
      .map(arg => arg.topics)
      .map(function (array, i) {
      // let result = new Array;
      // result = result.concat(array);
        topicArray.forEach(function (topic) {
          array.find(o => o.topic === topic) !== undefined ? array.push() : array.push({topic: topic, weight: 0});
        });
        return array;
      });

      // sort according to order of topicsArray
      topicsVectorExpand
      .forEach((list) => {
        list.sort(function (a, b) {
          return topicArray.indexOf(a.topic) - topicArray.indexOf(b.topic);
        });
      });
    // console.log('topicsVectorExpand: ', topicsVectorExpand);

    // cut argumentData to eight topics and other based on topic frequency
    let occurenceTopicVec = topicsVectorExpand
      .map(function (array) {
        // compute weight of topic: other
        let otherTopicsWeight = array
          .slice(0, 8)
          .reduce((a, b) => {return {topic: 'other', weight: a.weight + b.weight}});
        otherTopicsWeight.weight = 1 - otherTopicsWeight.weight;

        let arrayCut = array.slice(0, 8)
          .concat([otherTopicsWeight]);

        return arrayCut;
      });
    console.log('occurenceTopicVec: ', occurenceTopicVec);
      }
    });
    // console.log(topicOnlyFilter);


		var stance=[];
		var score=[];
		var topicsVector=[];
		var title=[];
		var url=[];

		for(var i=0;i<content.length;i++){
			stance[i]=content[i].stance;
			score[i]=content[i].score;
			topicsVector[i]=content[i].topics;
			title[i]=content[i].title;
			url[i]=content[i].url;
		}

		// var topicsNum=getTopicsNum(topicsVector);
		var topicsNum=6;
		//console.log(topicsNum);
		var preparedLabels=setLabel(topicsNum);
		//console.log(preparedLabels);
		var checkedTopics=topicsSelection();
		//console.log(checkedTopics);
		var verticesNumber=checkedTopics.length;
		//console.log(verticesNumber);

		var processedLabel=topicsAfterTopicSelection(checkedTopics,preparedLabels);
		//console.log(processedLabel);
		var processedWeight=weightAfterTopicSelection(checkedTopics,topicsVector,topicsNum);
		console.log(processedWeight);
		var processedData=argumentAfterTopicSelection(processedWeight);
		console.log(processedData);

		function getTopicsNum(argumentData){
			var arrayTopic=[]
			for(var i=0;i<argumentData.length;i++){
				for(var j=0;j<argumentData[i].length;j++){
					arrayTopic.push(argumentData[i][j].topicID);
				}
			}
			return Math.max.apply(null, arrayTopic);
		}
		function setLabel(num){
			var labelsA=[];
			for(i=0;i<=num;i++){
				//labelsA[i]="topic"+(i);
				labelsA[i]=labels[i];
			}
			return labelsA;
		}
		function topicsSelection(){
			var checkedTopics=[];
			var topics=document.getElementsByName('topic');
			for(var i=0;i<topics.length;i++){
				if(topics[i].checked){
					checkedTopics.push(i);
				}
			}
			return checkedTopics;
		}
		function topicsAfterTopicSelection(checkedTopics, labels){
			var processedLabel=[];
			for(var a=0;a<checkedTopics.length;a++){
				processedLabel[a]=labels[checkedTopics[a]]
			}
			return processedLabel;
		}
		function weightAfterTopicSelection(checkedTopics,argumentData,topicsNum){
			var freqArray=[];
			for(var i=0;i<argumentData.length;i++){
				freqArray[i]=new Array(topicsNum+1);
			}

			for(var i=0;i<argumentData.length;i++){
				for(var k=0;k<argumentData[i].length;k++){
					for(var j=0;j<=topicsNum;j++){
						if(j==argumentData[i][k].topic){
							freqArray[i][j]=argumentData[i][k].weight;
						}else if(freqArray[i][j]>0){
							freqArray[i][j]=freqArray[i][j];
						}else{
							freqArray[i][j]=0;
						}
					}
				}
			}
			//console.log(freqArray);

			var col=freqArray[0].length;
			var row=freqArray.length;

			var processedWeight=[];
			for(var i=0;i<row;i++){
				processedWeight[i]=new Array(checkedTopics.length);
			}

			for (var a=0;a<row;a++){
				for (var b=0;b<checkedTopics.length;b++){
					var n=checkedTopics[b];
					var m=parseFloat(freqArray[a][n])
					processedWeight[a][b]=m;
				}
			}
			//processedData=processedData.filter(remove)
			//console.log(processedData);
			return processedWeight;
		}
		function argumentAfterTopicSelection(processedWeight){
			var processedData=[];
			for(var i=0;i<processedWeight.length;i++){
				processedData.push({
					weight:processedWeight[i],
					score:score[i],
					stance:stance[i],
					title:title[i],
					url:url[i]
				})
			}
			processedData=processedData.filter(remove)
			return processedData;
		}
		function remove(value){
			var zeroVector=[];
			for(var i=0;i<value.weight.length;i++){
				zeroVector[i]=0;
			}
			var equalCheck=_.isEqual(value.weight,zeroVector);
			if(!equalCheck){
				return true;
			}
		}
		function clean(value){
			if(isNaN(value)){
				return true;
			}
		}
		function cleanSvg(){
			var Polygon=document.getElementById('polygon');
			while(Polygon.firstChild){
				Polygon.removeChild(Polygon.firstChild);
			}
		}
		// console.log(processedDataWithoutNull);
		polygon(processedData,d3.select('#polygon'),200,verticesNumber,processedLabel);
	}
</script>

<script type="text/javascript">

	function clear(){
		var item=document.getElementById('resultDisplay');
		while(item.firstChild){
			item.removeChild(item.firstChild);
		}
	}

  function tabOpenProCon(){
		prepare();
		searchQuery()
		function prepare(){
			clear();
	    var ProVsCon=document.createElement("div");
	    document.getElementById("resultDisplay").appendChild(ProVsCon);
			ProVsCon.setAttribute("id","ProVsCon");

			var Pro=document.createElement("div");
			document.getElementById("ProVsCon").appendChild(Pro);
			Pro.setAttribute("id","Pro");

			var Con=document.createElement("div");
			document.getElementById("ProVsCon").appendChild(Con);
			Con.setAttribute("id","Con");
		}
	}

  function tabOpenMds(){
		prepare();
		d3.text("topic_dist_per_doc.txt",function(data){
			var argumentData=getArgumentData(data);
			var topicsNum=getTopicsNum(argumentData);
			var processedData=getProcessedData(argumentData,topicsNum);
			//console.log(processedData);


			function getArgumentData(data){
				var argumentData=[];
				var data=data.split(/[[\]]/);
				for(var i=0;i<data.length;i++){
					if(isNaN(data[i])){
						data[i]=data[i].replace(/,/g,"");
						data[i]=data[i].split(/[(\)]/).filter(clean);
						argumentData.push(data[i]);
					}
				}
				//console.log(argumentData);
				for(var i=0;i<argumentData.length;i++){
					for(var j=0;j<argumentData[i].length;j++){
						var cell=argumentData[i][j].split(" ");
						var topicID=cell[0];
						var freq=cell[1];

						var newCell = {};
						newCell.topicID = topicID;
						newCell.freq = freq;
						argumentData[i][j]=newCell;
					}
				}
				return argumentData;
			}
			function getTopicsNum(argumentData){
				var arrayTopic=[]
				for(var i=0;i<argumentData.length;i++){
					for(var j=0;j<argumentData[i].length;j++){
						arrayTopic.push(argumentData[i][j].topicID);
					}
				}
				return Math.max.apply(null, arrayTopic);
			}
			function getProcessedData(argumentData,topicsNum){
				var freqArray=[];
				for(var i=0;i<argumentData.length;i++){
					freqArray[i]=new Array(topicsNum);
				}

				for(var i=0;i<argumentData.length;i++){
					for(var k=0;k<argumentData[i].length;k++){
						for(var j=0;j<topicsNum;j++){
							if(j==argumentData[i][k].topicID){
								freqArray[i][j]=argumentData[i][k].freq;
							}else if(freqArray[i][j]>0){
								freqArray[i][j]=freqArray[i][j];
							}else{
								freqArray[i][j]=0;
							}
						}
					}
				}
				//console.log(freqArray);
				return freqArray;
			}
			function clean(value){
				if(isNaN(value)){
					return true;
				}
			}
			euclidean(processedData);
			KL(processedData);
			Cosin(processedData);
		});
		function prepare(){
			clear();
			var mds=document.createElement("div");
			document.getElementById("resultDisplay").appendChild(mds);
			mds.setAttribute("id","mds");

			var euclideanDistance=document.createElement("div");
	    document.getElementById("mds").appendChild(euclideanDistance);
			euclideanDistance.setAttribute("id","euclideanDistance");

			var KLDistance=document.createElement("div");
	    document.getElementById("mds").appendChild(KLDistance);
			KLDistance.setAttribute("id","KLDistance");

			var CosineSimilarity=document.createElement("div");
	    document.getElementById("mds").appendChild(CosineSimilarity);
			CosineSimilarity.setAttribute("id","CosineSimilarity");
		}
 	}

  function tabOpenBarycentric(data){
		prepare();
		polygonCheck(data);

		for(var i=0;i<labels.length;i++){
		 	var subCheckbox=document.createElement("input");
			subCheckbox.type="checkbox";
			subCheckbox.class="checkbox"
			subCheckbox.name="topic";
			subCheckbox.value=labels[i];
			subCheckbox.id="id"+i;
			subCheckbox.class="box";
			subCheckbox.checked="checked";
			subCheckbox.onclick=polygonCheck;
	   	document.getElementById("checkbox").appendChild(subCheckbox);

			var label=document.createElement("label");
			label.htmlFor=labels[i];
	 	  label.appendChild(document.createTextNode(labels[i]));
			document.getElementById("checkbox").appendChild(label);
		 }


		function prepare(){
 			clear();

 			var barycentric=document.createElement("div");
 			document.getElementById("resultDisplay").appendChild(barycentric);
 			barycentric.setAttribute("id","barycentric");

 			var polygon=document.createElement("div");
 			document.getElementById("barycentric").appendChild(polygon);
 			polygon.setAttribute("id","polygon");

 			var checkbox=document.createElement("div");
 			document.getElementById("barycentric").appendChild(checkbox);
 			checkbox.setAttribute("id","checkbox");

			var proBox=document.createElement("div");
			document.getElementById("barycentric").appendChild(proBox);
			proBox.setAttribute("id","proBox");

			var proTitle=document.createElement("div");
			document.getElementById("barycentric").appendChild(proTitle);
			proTitle.setAttribute("id","proTitle");

			var conBox=document.createElement("div");
			document.getElementById("barycentric").appendChild(conBox);
			conBox.setAttribute("id","conBox");

			var conTitle=document.createElement("div");
			document.getElementById("barycentric").appendChild(conTitle);
			conTitle.setAttribute("id","conTitle");
 			}
	}
</script>

</head>

<body>
	<div id="container">
		<div id="header">
			<h1>Args.me</h1>
			<div class="SearchContainer">
					<input id="searchText" type="text" class="searchTerm"/>
					<button type="submit" class="searchButton" onclick="searchQuery()">Go!</button>
			</div>
		</div>
		<div id="body">
      <div id="tab">
        <ul>
          <li class="tablinks" onclick="tabOpenProCon()">Pro Vs. Con</li>
          <li class="tablinks" > | </li>
          <li class="tablinks" onclick="tabOpenMds()">MDS</li>
          <li class="tablinks" > | </li>
          <li class="tablinks" onclick="tabOpenBarycentric()">Barycentric </li>
        </ul>
      </div>
			<div id="resultDisplay"></div>
		</div>
		<div id="footer">
			<ul>
        	<li class="float-left"><a href="">HELP</a></li>
          <li class="float-left"><a href="">TERMS</a></li>
          <li class="float-left"><a href="">PRIVACY</a></li>
          <li class="float-left"><a href="">API</a></li>
          <li class="float-right"><a href="">ABOUT</a></li>
          <li class="float-right"><a href="">@2017WEBIS</a></li>
        </ul>
		</div>
	</div>
</body>
</html>
